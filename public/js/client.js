!function(){var d=document,w=window,dd=(parseInt,d.documentElement),db=d.body,dc="CSS1Compat"==d.compatMode,dx=dc?dd:db;encodeURIComponent;w.CHAT={msgObj:d.getElementById("message"),screenheight:w.innerHeight?w.innerHeight:dx.clientHeight,username:null,userid:null,socket:null,meshight:document.body.scrollHeight-108,scrollToBottom:function(){this.msgObj.scrollTop=this.msgObj.scrollHeight-this.meshight},logout:function(){location.reload()},submit:function(){var content=d.getElementById("content").value;if(""!=content){var obj={userid:this.userid,username:this.username,content:content};this.socket.emit("message",obj),d.getElementById("content").value=""}return!1},change:function(){var that=this,sendImage=d.getElementById("sendImage");if(0!=sendImage.files.length){var file=sendImage.files[0],reader=new FileReader;if(!reader)return console.log("读取图片失败"),void(sendImage.value="");reader.onload=function(e){sendImage.value="";var imgdata=e.target.result,obj={userid:that.userid,username:that.username,imgdata:imgdata};that.socket.emit("img",obj)},reader.readAsDataURL(file)}},_displayImage:function(obj){var isme=obj.userid==CHAT.userid?!0:!1,contentDiv='<div><a href="'+obj.imgdata+'" target="_blank"><img src="'+obj.imgdata+'"/></a></div>',usernameDiv="<span>"+obj.username+"</span>",section=d.createElement("section");isme?(section.className="user",section.innerHTML=contentDiv+usernameDiv):(section.className="service",section.innerHTML=usernameDiv+contentDiv),CHAT.msgObj.appendChild(section),CHAT.scrollToBottom()},genUid:function(){return(new Date).getTime()+""+Math.floor(899*Math.random()+100)},updateSysMsg:function(o,action){var onlineUsers=o.onlineUsers,onlineCount=o.onlineCount,user=o.user,userhtml="",separator="";for(key in onlineUsers)onlineUsers.hasOwnProperty(key)&&(userhtml+=separator+onlineUsers[key],separator="、");d.getElementById("onlinecount").innerHTML="当前共有 "+onlineCount+" 人在线，在线列表："+userhtml;var html="";html+='<div class="msg-system">',html+=user.username,html+="login"==action?" 加入了聊天室":" 退出了聊天室",html+="</div>";var section=d.createElement("section");section.className="system J-mjrlinkWrap J-cutMsg",section.innerHTML=html,this.msgObj.appendChild(section),this.scrollToBottom()},usernameSubmit:function(){var username=d.getElementById("username").value;return""!=username&&(d.getElementById("username").value="",d.getElementById("loginbox").style.display="none",d.getElementById("chatbox").style.display="block",this.init(username)),!1},init:function(username){var that=this;this.userid=this.genUid(),this.username=username,d.getElementById("showusername").innerHTML=this.username,this.msgObj.style.maxHeight=this.meshight+"px",this.scrollToBottom(),this.socket=io.connect("http://raclen-wenzhang.coding.io"),this.socket.emit("login",{userid:this.userid,username:this.username}),this.socket.on("login",function(o){CHAT.updateSysMsg(o,"login")}),this.socket.on("logout",function(o){CHAT.updateSysMsg(o,"logout")}),this.socket.on("message",function(obj){var isme=obj.userid==CHAT.userid?!0:!1,contentDiv="<div>"+obj.content+"</div>",usernameDiv="<span>"+obj.username+"</span>",section=d.createElement("section");isme?(section.className="user",section.innerHTML=contentDiv+usernameDiv):(section.className="service",section.innerHTML=usernameDiv+contentDiv),CHAT.msgObj.appendChild(section),CHAT.scrollToBottom()}),this.socket.on("newImg",function(obj){that._displayImage(obj)})}},d.getElementById("username").onkeydown=function(e){e=e||event,13===e.keyCode&&CHAT.usernameSubmit()},d.getElementById("content").onkeydown=function(e){e=e||event,13===e.keyCode&&CHAT.submit()},d.getElementById("mjr_send").addEventListener("click",function(){CHAT.submit()}),d.getElementById("go").addEventListener("click",function(){CHAT.usernameSubmit()}),d.getElementById("sendImage").addEventListener("change",function(){CHAT.change()})}();