!function(){var e=document,n=window,t=(parseInt,e.documentElement),s=e.body,i="CSS1Compat"==e.compatMode,o=i?t:s;encodeURIComponent;n.CHAT={msgObj:e.getElementById("message"),screenheight:n.innerHeight?n.innerHeight:o.clientHeight,username:null,userid:null,socket:null,meshight:document.body.scrollHeight-108,scrollToBottom:function(){this.msgObj.scrollTop=this.msgObj.scrollHeight-this.meshight},logout:function(){location.reload()},submit:function(){var n=e.getElementById("content").value;if(""!=n){var t={userid:this.userid,username:this.username,content:n};this.socket.emit("message",t),e.getElementById("content").value=""}return!1},change:function(){var n=this,t=e.getElementById("sendImage");if(0!=t.files.length){var s=t.files[0],i=new FileReader;if(!i)return console.log("读取图片失败"),void(t.value="");i.onload=function(e){t.value="";var s=e.target.result,i={userid:n.userid,username:n.username,imgdata:s};n.socket.emit("img",i)},i.readAsDataURL(s)}},_displayImage:function(n){var t=n.userid==CHAT.userid?!0:!1,s='<div><a href="'+n.imgdata+'" target="_blank"><img src="'+n.imgdata+'"/></a></div>',i="<span>"+n.username+"</span>",o=e.createElement("section");t?(o.className="user",o.innerHTML=s+i):(o.className="service",o.innerHTML=i+s),CHAT.msgObj.appendChild(o),CHAT.scrollToBottom()},genUid:function(){return(new Date).getTime()+""+Math.floor(899*Math.random()+100)},updateSysMsg:function(n,t){var s=n.onlineUsers,i=n.onlineCount,o=n.user,a="",r="";for(key in s)s.hasOwnProperty(key)&&(a+=r+s[key],r="、");e.getElementById("onlinecount").innerHTML="当前共有 "+i+" 人在线，在线列表："+a;var m="";m+='<div class="msg-system">',m+=o.username,m+="login"==t?" 加入了聊天室":" 退出了聊天室",m+="</div>";var l=e.createElement("section");l.className="system J-mjrlinkWrap J-cutMsg",l.innerHTML=m,this.msgObj.appendChild(l),this.scrollToBottom()},usernameSubmit:function(){var n=e.getElementById("username").value;return""!=n&&(e.getElementById("username").value="",e.getElementById("loginbox").style.display="none",e.getElementById("chatbox").style.display="block",this.init(n)),!1},init:function(n){var t=this;this.userid=this.genUid(),this.username=n,e.getElementById("showusername").innerHTML=this.username,this.msgObj.style.maxHeight=this.meshight+"px",this.scrollToBottom(),this.socket=io.connect("http://raclen-wenzhang.coding.io"),this.socket.emit("login",{userid:this.userid,username:this.username}),this.socket.on("login",function(e){CHAT.updateSysMsg(e,"login")}),this.socket.on("logout",function(e){CHAT.updateSysMsg(e,"logout")}),this.socket.on("message",function(n){var t=n.userid==CHAT.userid?!0:!1,s="<div>"+n.content+"</div>",i="<span>"+n.username+"</span>",o=e.createElement("section");t?(o.className="user",o.innerHTML=s+i):(o.className="service",o.innerHTML=i+s),CHAT.msgObj.appendChild(o),CHAT.scrollToBottom()}),this.socket.on("newImg",function(e){t._displayImage(e)})}},e.getElementById("username").onkeydown=function(e){e=e||event,13===e.keyCode&&CHAT.usernameSubmit()},e.getElementById("content").onkeydown=function(e){e=e||event,13===e.keyCode&&CHAT.submit()},e.getElementById("mjr_send").addEventListener("click",function(){CHAT.submit()}),e.getElementById("go").addEventListener("click",function(){CHAT.usernameSubmit()}),e.getElementById("sendImage").addEventListener("change",function(){CHAT.change()})}();